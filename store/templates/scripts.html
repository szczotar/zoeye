{% load static %}

<!-- JavaScript files-->
<!-- Upewnij się, że używasz Bootstrap 5 JS, jest kluczowy dla Offcanvas i Dropdownów -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/jquery.min.js' %}"></script>
<script src="{% static 'js/lightbox.min.js' %}"></script>
<script src="{% static 'js/nouislider.min.js' %}"></script> 



<!-- Font Awesome - kluczowe dla nowych ikon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<script>
    $(document).ready(function() {

        // --- GLOBALNE FUNKCJE POMOCNICZE ---

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        function showCustomAlert(message, type = 'info') {
            const $container = $('#custom-alerts-container');
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            const $alert = $(alertHtml);
            $container.append($alert);
            setTimeout(function() {
                $alert.alert('close');
            }, 5000);
            $alert.on('closed.bs.alert', function () {
                $(this).remove();
            });
        }

        function handleAjaxResponse(json) {
            console.log("Handling AJAX response:", json);
            
            // Aktualizacja ilości i ceny w navbarze
            if (json.qty !== undefined) {
                 $('#cart_quantity').text(json.qty);
                 var $cartQuantitySpan = $('#cart_quantity');
                 var $cartTotalPriceSpan = $('#cart_total_price');

                 if (json.qty > 0) { 
                     $cartQuantitySpan.removeClass('d-none');
                     $cartTotalPriceSpan.removeClass('d-none');
                 } else { 
                     $cartQuantitySpan.addClass('d-none'); 
                     $cartTotalPriceSpan.addClass('d-none');
                 }
            }
            if (json.cart_total !== undefined) {
                 // Aktualizacja ceny w navbarze
                 if ($('#cart_total_price').length) {
                    $('#cart_total_price').text(Number(json.cart_total).toFixed(2) + ' zł');
                 }
                 // Aktualizacja ceny na stronie koszyka
                 if ($('#cart-total-display').length) {
                    $('#cart-total-display').text(Number(json.cart_total).toFixed(2) + ' zł');
                 }
                 if ($('#order-total-display').length) {
                    $('#order-total-display').text(Number(json.cart_total).toFixed(2) + ' zł');
                 }
                 if ($('.btn-block[href="{% url 'checkout' %}"]').length) {
                     if (json.qty > 0) { $('.btn-block[href="{% url 'checkout' %}"]').removeClass('disabled'); } else { $('.btn-block[href="{% url 'checkout' %}"]').addClass('disabled'); }
                 }
            }

            if (json.message) {
                 showCustomAlert(json.message, 'success');
            }
            if ($('table.table').length) {
                 if (json.item_key && json.item_subtotal !== undefined) {
                     $('#subtotal-' + json.item_key).text(Number(json.item_subtotal).toFixed(2) + ' zł');
                 }
                  if (json.type === 'delete' && json.item_key) {
                      $('#item-' + json.item_key).fadeOut(300, function() { $(this).remove(); });
                      if (json.qty === 0) {
                          $('tbody').html('<tr><td colspan="5" class="text-center border-0">Your cart is empty.</td></tr>');
                      }
                  }
            }
        }

        function handleAjaxError(xhr, errmsg, err) {
            console.error("AJAX error:", errmsg, err, xhr.responseText);
            let errorMsg = "Wystąpił błąd.";
            try {
                const errorJson = JSON.parse(xhr.responseText);
                errorMsg = errorJson.error || errorJson.message || xhr.statusText || errmsg || "Nieznany błąd.";
            } catch (e) {
                errorMsg = xhr.statusText || errmsg || "Wystąpił nieznany błąd.";
            }
            showCustomAlert("Błąd: " + errorMsg, 'danger');
        }


        // --- LOGIKA DLA STRONY PRODUKTU ---
        $(document).on('submit', '#product_addtocart_form', function(e) {
            e.preventDefault();
            if ($('#add-cart').is(':disabled')) return;
            var itemId = $('#selected-item-id').val();
            if (!itemId) {
                 showCustomAlert("Proszę wybrać wariację produktu.", "warning");
                 return;
            }
            var quantity = parseInt($('#qty').val() || '1');
            if (quantity <= 0) {
                 showCustomAlert("Ilość musi być większa niż 0.", "warning");
                 return;
            }
            var postData = { quantity: quantity, action: 'post' };
            if ($('#size-select').length > 0) {
                postData['variation_id'] = itemId;
            } else {
                postData['product_id'] = itemId;
            }
            $.ajax({
                type: 'POST',
                url: '{% url 'cart_add' %}',
                data: postData,
                success: handleAjaxResponse,
                error: handleAjaxError
            });
        });

        // --- LOGIKA DLA KOSZYKA (cart_summary.html) ---

        // Aktualizacja ilości
        $(document).on('change', '.quantity-input', function() {
            var $input = $(this);
            var itemKey = $input.data('item-key');
            var newQuantity = parseInt($input.val() || '0');

            if (newQuantity < 0) {
                showCustomAlert("Ilość nie może być ujemna.", "warning");
                location.reload();
                return;
            }
            if (newQuantity === 0) {
                $('.remove-item-button[data-item-key="' + itemKey + '"]').click();
                return;
            }

            $.ajax({
                type: 'POST',
                url: '{% url "cart_update" %}',
                data: {
                    item_key: itemKey,
                    quantity: newQuantity,
                    action: 'post'
                },
                dataType: 'json',
                success: handleAjaxResponse,
                error: handleAjaxError
            });
        });

        // Usuwanie produktu
        $(document).on('click', '.remove-item-button', function(e) {
            e.preventDefault();
            var $button = $(this);
            var itemKey = $button.data('item-key');

            $.ajax({
                type: 'POST',
                url: '{% url "cart_delete" %}',
                data: {
                    item_key: itemKey,
                    action: 'post'
                },
                dataType: 'json',
                success: handleAjaxResponse,
                error: handleAjaxError
            });
        });

    });

    document.addEventListener('DOMContentLoaded', function() {
    // Znajdź element nawigacji
    const navbar = document.querySelector('.my-higher-navbar');
    
    // Ustaw próg przewinięcia (w pikselach), po którym zmieni się wygląd nawigacji
    const scrollThreshold = 50; 

    if (navbar) {
        // Funkcja, która będzie sprawdzać pozycję scrolla
        const handleScroll = () => {
            if (window.scrollY > scrollThreshold) {
                // Jeśli użytkownik przewinął stronę poniżej progu, dodaj klasę
                navbar.classList.add('navbar-scrolled');
            } else {
                // W przeciwnym razie, usuń klasę
                navbar.classList.remove('navbar-scrolled');
            }
        };

        // Uruchom funkcję przy każdym zdarzeniu przewijania
        window.addEventListener('scroll', handleScroll);
        
        // Sprawdź stan od razu po załadowaniu strony (na wypadek, gdyby strona była przeładowana w połowie)
        handleScroll();
    }
});

  document.addEventListener('DOMContentLoaded', function() {
        const manageCookiesLink = document.getElementById('manage-cookies-link');

        if (manageCookiesLink) {
            manageCookiesLink.addEventListener('click', function(event) {
                event.preventDefault(); // Zapobiegaj domyślnej akcji linku

                // Sprawdź, czy API Piwik PRO jest dostępne, zanim go użyjesz
                if (typeof ppms !== 'undefined' && ppms.cm && typeof ppms.cm.api === 'function') {
                    ppms.cm.api('renderConsentForm');
                } else {
                    console.error('Piwik PRO Consent Manager (ppms.cm.api) is not available.');
                    alert('Nie można w tej chwili otworzyć ustawień zgód. Spróbuj odświeżyć stronę.');
                }
            });
        }
    });
</script>