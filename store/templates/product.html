{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load rating_filters %}
{% load custom_filters %}

{# Linki do Swipera #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
{# NOWOŚĆ: Link do CSS biblioteki Fancybox #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>


<div class="container mt-4">

    <div class="row product-layout-row" style="background-color:#F7F7F7;">

        <!-- WIDOK ZDJĘĆ NA DESKTOP -->
        <div class="col-lg-8 d-none d-lg-flex">
            <div class="row g-0 w-100">
                <div class="col-2">
                    <div class="product-thumbnails-list pe-3">
                        {% if product.images.all %}
                        {% for image_obj in product.images.all %}
                        <div class="thumbnail-item mb-2 {% if forloop.first %}active{% endif %}" data-src="{{ image_obj.image.url }}">
                            <img src="{{ image_obj.image.url }}" class="img-fluid thumbnail-image" alt="{{ image_obj.alt_text|default:'Miniatura' }}">
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="thumbnail-item mb-2 active" data-src="{% static 'img/kolczyki.png' %}">
                            <img src="{% static 'img/kolczyki.png' %}" class="img-fluid thumbnail-image" alt="Domyślna miniatura">
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-10">
                    <!-- ZMIANA: Dodajemy link <a> wokół obrazka dla Fancybox -->
                    <div class="product-main-image-container">
                        {% if product.images.all %}
                        <a href="{{ product.images.first.image.url }}" data-fancybox="gallery" class="main-product-image-wrapper" id="mainProductImageLink">
                            <img src="{{ product.images.first.image.url }}" id="mainProductImage" class="img-fluid main-product-image" alt="{{ product.name }}">
                        </a>
                        {% else %}
                        <img src="{% static 'img/kolczyki.png' %}" id="mainProductImage" class="img-fluid main-product-image-fallback" alt="Brak zdjęcia dla produktu">
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- WIDOK ZDJĘĆ NA MOBILE (bez zmian) -->
        <div class="col-12 d-lg-none">
            <div class="swiper product-swiper-mobile">
                <div class="swiper-wrapper">
                    {% if product.images.all %}
                        {% for image_obj in product.images.all %}
                        <div class="swiper-slide">
                            <img src="{{ image_obj.image.url }}" class="img-fluid" alt="{{ image_obj.alt_text|default:product.name }}">
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="swiper-slide">
                            <img src="{% static 'img/kolczyki.png' %}" class="img-fluid" alt="Brak zdjęcia dla produktu">
                        </div>
                    {% endif %}
                </div>
                <div class="swiper-pagination"></div>
            </div>
        </div>


        {# Prawa kolumna - Informacje o produkcie (bez zmian) #}
        <div class="col-12 col-lg-4">
            {# ... reszta Twojego kodu dla informacji o produkcie, formularza, etc. ... #}
            {# ... bez zmian ... #}
             <form action="{% url 'cart_add' %}" method="post" id="product_addtocart_form">
                {% csrf_token %}
                <input type="hidden" name="item_id" id="selected-item-id" value="">
                <input type="hidden" name="quantity" id="qty" value="1">
               <div class="product-info-box d-flex flex-column align-items-center justify-content-center">
                    <br><br>
                    <div class="product-header-detail mb-3 text-center">
                        <h1 class="product-name-detail h3 mb-0">{{ product.name }}</h1>
                    </div>
                    <div class="price-box-detail mb-3 text-center">
                        {% if product.is_sale %}
                           <p class="product-sale-price h4 mb-0 text-sale-price">{{ product.sale_price }} zł</p>
                           <div class="sale-details mt-3">
                                <p class="small text-muted lowest-price-line mb-0">Najniższa cena z 30 dni: {{ product.sale_price }} zł</p>
                                <p class="small text-muted product-sale-price mb-0">Cena regularna: <del>{{ product.price }} zł</del></p>
                           </div>
                       {% else %}
                           <p class="product-price-detail h4 mb-0">{{ product.price }} zł</p>
                       {% endif %}
                    </div>
                    {% if product.has_multiple_variations %}
                        <div class="variation-select-section my-4 text-center p-3 ">
                            <div class="form-group">
                                <label for="size-select">obwód nadgarstka:</label>
                                <select class="form-control" id="size-select">
                                    <option value="">-- Wybierz rozmiar --</option>
                                    {% for variation in variations %}
                                    <option value="{{ variation.id }}" data-stock="{{ variation.stock }}" {% if variation.stock <= 0 %}disabled{% endif %}>
                                        {{ variation.size|default:"Brak rozmiaru" }}
                                        {% if variation.stock <= 0 %} (Brak w magazynie) {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div id="variation-info" class="mt-2 small text-muted"></div>
                        </div>
                    {% elif product.has_variations %}
                         {% with single_variation=variations.first %}
                            <div class="single-variation-info my-4 text-center p-3">
                                <p>Rozmiar: {{ single_variation.size|default:"Uniwersalny" }}</p>
                                {% if single_variation.stock > 0 %}
                                    <p class="text-success">Dostępność: {{ single_variation.stock }} szt.</p>
                                {% endif %}
                                <input type="hidden" id="single-variation-id" value="{{ single_variation.id }}">
                                <input type="hidden" id="single-variation-stock" value="{{ single_variation.stock }}">
                            </div>
                         {% endwith %}
                    {% else %}
                        <div class="no-variation-info my-4 text-center p-3">
                            <p>Rozmiar: Uniwersalny</p>
                            {% if product.stock < 3 and product.stock > 0 %}
                                <p class="text-danger">ostatnie sztuki!</p>
                                <input type="hidden" id="single-product-id" value="{{ product.id }}">
                                <input type="hidden" id="single-product-stock" value="{{ product.stock }}">
                            {% endif %}
                        </div>
                    {% endif %}
                    <div class="add-to-cart-section-detail my-4 text-center p-3">
                        {% if product.is_available %}
                            <button type="submit" id="add-cart" class="btn btn-dark custom-add-to-cart-button">Dodaj do koszyka</button>
                        {% else %}
                            <button type="button" class="btn btn-secondary custom-add-to-cart-button" disabled>Brak w magazynie</button>
                        {% endif %}
                        <div class="small text-muted mt-3">
                            <p class="mb-0">Wysyłka: 1 dzień roboczy</p>
                            <p class="mb-0">Darmowa dostawa od 300zl</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {# ... reszta Twojego kodu (Opis, Opinie, Podobne produkty) ... #}
    {# ... bez zmian ... #}
    <br>

    <div class="product-description-section-detail mt-5">
        <div class="collapse-trigger d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#collapseDescription" aria-expanded="false" aria-controls="collapseDescription" role="button">
             <h4 class="reviews-heading-detail mb-0">Opis produktu</h4>
             <i class="fas fa-chevron-down"></i>
        </div>
        <hr class="description-separator-detail mt-2 mb-3" />
        <div class="collapse" id="collapseDescription">
            <p class="product-description-detail">{{ product.description|linebreaksbr }}</p>
        </div>
    </div>

    <div class="reviews-section mt-5">
        <div class="collapse-trigger d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#collapseReviews" aria-expanded="false" aria-controls="collapseReviews" role="button">
             <h4 class="reviews-heading-detail mb-0">Opinie</h4>
             <i class="fas fa-chevron-down"></i>
        </div>
        <hr class="reviews-separator-detail mt-2 mb-3" />
        <div class="collapse" id="collapseReviews">
            <div class="row">
                <div class="col-md-5">
                    <div class="rating-summary p-3 border rounded bg-light">
                        <h5 class="mb-3">Średnia ocen</h6>
                        {% if rating_count > 0 %}
                            <div class="average-rating mb-4 text-center">
                                <p class="mb-0 h2"><strong>{{ average_rating|default:"N/A" }}</strong></p>
                                <div class="stars h4">{{ average_rating|render_stars }}</div>
                                <p class="mb-0 text-muted">na podstawie {{ rating_count }} ocen</p>
                            </div>
                        {% else %}
                             <div class="average-rating mb-4 text-center">
                                 <p class="mb-0 h4 text-muted">Brak ocen dla tego produktu.</p>
                             </div>
                        {% endif %}
                        {% if rating_count > 0 %}
                            <div class="rating-distribution mt-4">
                                <h6 class="mb-2">Rozkład ocen:</h6>
                             {% for rating_value in rating_values %}
                            {% with count=rating_distribution|get_item:rating_value|default:0 %}
                                <div class="rating-distribution-item">
                                    <span class="stars">{{ rating_value|render_stars }}</span>
                                    <span class="count text-muted">{{ count }}</span>
                                </div>
                            {% endwith %}
                        {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="add-review-form mt-5">
                        <h5 class="mb-3">Dodaj swoją opinię</h5>
                        {% if request.user.is_authenticated %}
                            <form method="post" action="{% url 'add_review' product.id %}">
                                {% csrf_token %}
                                <div class="form-group mb-3">
                                    <label class="form-label d-block">Twoja ocena:</label>
                                    <div class="rating-input-stars">
                                        {% for i in "54321" %}
                                            <input type="radio" id="rating-{{ i }}" name="rating" value="{{ i }}" required>
                                            <label for="rating-{{ i }}" title="{{ i }} gwiazdek">
                                                <i class="fas fa-star"></i>
                                            </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="comment">Twój komentarz:</label>
                                    <textarea name="comment" id="comment" class="form-control" rows="4" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Wyślij opinię</button>
                            </form>
                        {% else %}
                            <p class="text-muted">Zaloguj się, aby dodać recenzję.</p>
                            <p><a href="{% url 'login' %}?next={{ request.get_full_path }}">Zaloguj się</a></p>
                        {% endif %}
                    </div>

                    <!-- === KONTENER NA DYNAMICZNIE ŁADOWANE RECENZJE === -->
                    <div id="reviews-container" data-product-id="{{ product.id }}">
                        {% include 'partials/reviews_section.html' %}
                    </div>
                    <!-- === KONIEC KONTENERA === -->

                </div>
            </div>
        </div>
    </div>

    {% if similar_products %}
    <div class="similar-products-section mt-5">
        <header class="text-center">
            <p class="small text-muted small text-uppercase mb-1">Podobne produkty</p>
            <h3 class="similar-products-heading mb-4">Produkty z tym samym materiałem</h3>
        </header>
        <div class="swiper-container-wrapper swiper-items-wrapper">
            <div class="swiper swiper-items similar-products-swiper">
                <div class="swiper-wrapper">
                    {% for similar_product in similar_products %}
                    <div class="swiper-slide">
                        <div class="product text-center">
                            <div class="mb-3 position-relative">
                                <div class="badge text-white badge-"></div>
                                <a class="d-block" href="{% url 'product' similar_product.id  %}">
                                    {% if similar_product.images.all %}
                                    <div id="similarProductCardCarousel{{ similar_product.id }}" class="carousel slide card-product-carousel" data-bs-ride="false" data-bs-interval="false">
                                        <div class="carousel-inner">
                                            {% for image_obj in similar_product.images.all %}
                                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                                <img src="{{ image_obj.image.url }}" class="d-block w-100 carousel-img" alt="{{ image_obj.alt_text|default:similar_product.name }}">
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% else %}
                                    <img src="{% static 'img/kolczyki.png' %}" class="img-fluid w-100 card-fallback-img" alt="Brak zdjęcia dla produktu">
                                    {% endif %}
                                </a>
                            </div>
                            <div class="product-info">
                                <a href="{% url 'product' similar_product.id %}" style="text-decoration: none; color: inherit;">
                                    <h6 class="product-name">{{ similar_product.name }}</h6>
                                </a>
                                <p class="small text-muted product-price-display">
                                     {% if similar_product.has_variations %}
                                        Od {{ similar_product.get_effective_price }} zł
                                     {% else %}
                                        {% if similar_product.is_sale %}
                                            <span class="text-sale-price">{{ similar_product.sale_price }} zł</span> <span class="text-muted"><del>{{ similar_product.price }} zł</del></span>
                                        {% else %}
                                            {{ similar_product.price }} zł
                                        {% endif %}
                                     {% endif %}
                                </p>
                                {% if similar_product.is_sale %}
                                     <p class="small text-muted lowest-price-line">Najniższa cena z 30 dni: {{ similar_product.sale_price }} zł</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="swiper-pagination similar-products-pagination"></div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

{# NOWOŚĆ: Skrypt JS biblioteki Fancybox #}
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
<script>
    $(document).ready(function() {
        // === ZMIANA: Zaktualizowany skrypt do zmiany głównego zdjęcia ===
        $('.thumbnail-item').on('click', function() {
            $('.thumbnail-item').removeClass('active');
            $(this).addClass('active');

            var newImageUrl = $(this).data('src');
            var altText = $(this).find('img').attr('alt');

            // Aktualizuj zarówno obrazek (src) jak i link do pop-upu (href)
            $('#mainProductImage').attr('src', newImageUrl).attr('alt', altText);
            $('#mainProductImageLink').attr('href', newImageUrl);
        });

        // === NOWOŚĆ: Inicjalizacja Fancybox ===
        // Wystarczy dodać atrybut data-fancybox do linku,
        // ale możemy też dodać opcje konfiguracyjne tutaj, jeśli zajdzie potrzeba.
        Fancybox.bind("[data-fancybox]", {
          // Twoje opcje konfiguracyjne, np. tłumaczenia
          l10n: {
            CLOSE: "Zamknij",
            NEXT: "Następny",
            PREV: "Poprzedni",
            MODAL: "Możesz zamknąć to okno klawiszem ESC",
            ERROR: "Wystąpił błąd, nie można załadować zawartości.",
            IMAGE_ERROR: "Nie znaleziono obrazka.",
            ELEMENT_NOT_FOUND: "Nie znaleziono elementu HTML.",
            AJAX_NOT_FOUND: "Błąd wczytywania AJAX: Nie znaleziono",
            AJAX_FORBIDDEN: "Błąd wczytywania AJAX: Brak uprawnień",
            IFRAME_ERROR: "Błąd podczas ładowania strony.",
          }
        });


        // === Reszta Twoich skryptów (bez zmian) ===
        const sizeSelect = document.getElementById('size-select');
        const selectedItemIdInput = document.getElementById('selected-item-id');
        const addToCartButton = document.getElementById('add-cart');
        const variationInfoDiv = document.getElementById('variation-info');
        const quantityInput = document.getElementById('qty');

        const hasMultipleVariations = {{ product.has_multiple_variations|lower }};
        const hasVariations = {{ product.has_variations|lower }};

        if (hasMultipleVariations) {
            if (addToCartButton) {
                 addToCartButton.disabled = true;
            }
            if (sizeSelect) {
                 sizeSelect.addEventListener('change', function() {
                    const selectedOption = sizeSelect.options[sizeSelect.selectedIndex];
                    const variationId = selectedOption.value;
                    const stock = parseInt(selectedOption.getAttribute('data-stock'));
                    selectedItemIdInput.value = variationId;
                    if (variationId) {
                        let infoHtml = '';
                        if (stock > 0 && stock < 3) {
                            infoHtml += `<p class="text-danger">Ostatnie sztuki!`;
                            quantityInput.max = stock;
                            if (parseInt(quantityInput.value) > stock) {
                                quantityInput.value = stock > 0 ? stock : 1;
                            }
                        } else if (stock >= 3) {
                            infoHtml += `<p class="text-success"></p>`;
                             quantityInput.max = 9999;
                        } else {
                             infoHtml += `<p class="text-danger">Brak w magazynie</p>`;
                              quantityInput.max = 1;
                              quantityInput.value = 1;
                        }
                        variationInfoDiv.innerHTML = infoHtml;
                    } else {
                        variationInfoDiv.innerHTML = '';
                        selectedItemIdInput.value = '';
                         quantityInput.max = 9999;
                         quantityInput.value = 1;
                    }
                    if (addToCartButton) {
                         if (variationId && stock > 0) {
                             addToCartButton.disabled = false;
                         } else {
                             addToCartButton.disabled = true;
                         }
                    }
                });
            }
        } else if (hasVariations) {
            const singleVariationId = document.getElementById('single-variation-id')?.value;
            const singleVariationStock = parseInt(document.getElementById('single-variation-stock')?.value || '0');
            if (selectedItemIdInput && singleVariationId) {
                selectedItemIdInput.value = singleVariationId;
            }
            if (quantityInput) {
                quantityInput.max = singleVariationStock > 0 ? singleVariationStock : 1;
                if (parseInt(quantityInput.value) > singleVariationStock) {
                     quantityInput.value = singleVariationStock > 0 ? singleVariationStock : 1;
                }
            }
        } else {
             const singleProductId = document.getElementById('single-product-id')?.value;
             const singleProductStock = parseInt(document.getElementById('single-product-stock')?.value || '0');
             if (selectedItemIdInput && singleProductId) {
                 selectedItemIdInput.value = singleProductId;
             }
            if (quantityInput) {
                 quantityInput.max = singleProductStock > 0 ? singleProductStock : 1;
                 if (parseInt(quantityInput.value) > singleProductStock) {
                      quantityInput.value = singleProductStock > 0 ? singleProductStock : 1;
                 }
            }
        }

        // === INICJALIZACJA SLIDERA PODOBNYCH PRODUKTÓW (SWIPER) ===
        const similarProductsSwiper = new Swiper('.similar-products-swiper', {
            slidesPerView: 1,
            spaceBetween: 10,
            loop: false,
            pagination: {
                el: '.similar-products-pagination',
                clickable: true,
            },
            breakpoints: {
                576: { slidesPerView: 2, spaceBetween: 10 },
                768: { slidesPerView: 3, spaceBetween: 15 },
                992: { slidesPerView: 4, spaceBetween: 20 },
            },
            observer: true,
            observeParents: true,
        });

        // === NOWY SKRYPT: EFEKT ZMIANY ZDJĘCIA PO NAJECHANIU DLA PODOBNYCH PRODUKTÓW ===
        const similarProductCards = document.querySelectorAll('.similar-products-section .product');
        similarProductCards.forEach(card => {
            const carousel = card.querySelector('.card-product-carousel');
            if (carousel) {
                const firstItem = carousel.querySelector('.carousel-item:first-child');
                const secondItem = carousel.querySelector('.carousel-item:nth-child(2)');

                // Dodaj listenery tylko jeśli są co najmniej 2 zdjęcia
                if (firstItem && secondItem) {
                    card.addEventListener('mouseenter', () => {
                        firstItem.classList.remove('active');
                        secondItem.classList.add('active');
                    });

                    card.addEventListener('mouseleave', () => {
                        secondItem.classList.remove('active');
                        firstItem.classList.add('active');
                    });
                }
            }
        });

        // === SKRYPT: DYNAMICZNE ŁADOWANIE RECENZJI ===
        const reviewsContainer = $('#reviews-container');
        const productId = reviewsContainer.data('productId');
        reviewsContainer.on('click', '.pagination a', function(e) {
            e.preventDefault();
            const page = $(this).data('page');
            if (!page) {
                return;
            }
            const url = `/product/${productId}/reviews/?page=${page}`;
            $.ajax({
                url: url,
                type: 'GET',
                beforeSend: function() {
                    reviewsContainer.html('<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');
                },
                success: function(data) {
                    reviewsContainer.html(data);
                    $('html, body').animate({
                        scrollTop: reviewsContainer.offset().top - 100
                    }, 500);
                },
                error: function() {
                    reviewsContainer.html('<p class="text-danger text-center">Wystąpił błąd podczas ładowania recenzji.</p>');
                }
            });
        });

        // === SKRYPT: INICJALIZACJA SWIPERA DLA ZDJĘĆ PRODUKTU NA MOBILE ===
        let productSwiperMobile;
        const breakpoint = 992;
        function initOrDestroyProductSwiper() {
            const swiperEl = document.querySelector('.product-swiper-mobile');
            if (!swiperEl) return;
            if (window.innerWidth < breakpoint && productSwiperMobile === undefined) {
                productSwiperMobile = new Swiper(swiperEl, {
                    loop: true,
                    pagination: {
                        el: '.swiper-pagination',
                        clickable: true,
                    },
                    a11y: {
                      enabled: true,
                      prevSlideMessage: 'Poprzednie zdjęcie',
                      nextSlideMessage: 'Następne zdjęcie',
                    },
                });
            } else if (window.innerWidth >= breakpoint && productSwiperMobile !== undefined) {
                productSwiperMobile.destroy(true, true);
                productSwiperMobile = undefined;
            }
        }
        initOrDestroyProductSwiper();
        window.addEventListener('resize', initOrDestroyProductSwiper);
    });
</script>
{% endblock %}