{% extends 'base.html' %}
{% load static %}
{% load l10n %}

{% block content %}

<style>

    .accordion-body {
        padding: 1rem 1.25rem;
    }
    /* Zmniejszenie przycisków nagłówka akordeonu */
    .accordion-button {
        padding: 0.8rem 1.25rem;
        font-size: 1rem;
    }
    .accordion-button:not(.collapsed) {
        color: #495057;
        background-color: #FFE4C6;
        box-shadow: none;
    }
    .accordion-button:focus {
    box-shadow: none;
    border-color: rgba(141, 44, 44, 0.548); /* Opcjonalnie: przywraca domyślny kolor ramki */
}
    .accordion-button.disabled {
        background-color: #e9ecef;
        color: #6c757d;
        pointer-events: none;
    }
 
   /* Style dla mniejszych pól formularza */
    .form-floating.form-floating-sm .form-control {
        min-height: calc(2.5rem + 2px); /* Mniejsza wysokość */
        height: calc(2.5rem + 2px);
        padding: 0.75rem 0.75rem 0;
        font-size: 0.875rem;
    }
    .form-floating.form-floating-sm label {
        padding: 0.5rem 0.75rem; /* Mniejszy padding etykiety */
        font-size: 0.875rem;
    }
    .summary-table { font-size: 0.9rem; }
    .summary-table td { padding: 0.4rem 0; } /* Mniejszy padding w tabeli */
    .summary-table .total-row td {
        font-weight: bold;
        font-size: 1rem;
        border-top: 1px solid #dee2e6;
        padding-top: 0.8rem;
    }
    .form-control:read-only {
        background-color: #e9ecef;
    }
    /* Zmniejszenie czcionki dla opisów i checkboxów */
    .accordion-body p, .form-check-label {
        font-size: 0.9rem;
    }

        inpost-geowidget {
        display: block; /* Upewnij się, że jest traktowany jak blok */
        width: 100%;    /* Szerokość na 100% kontenera */
        height: 500px;  /* Ustaw pożądaną wysokość, np. 500px */
    }
    

    
</style>

<style>
    .header-background {
        background-color: #ffffff; /* Ciemny kolor, pasujący do navbara */
        height: 110px;
        margin-bottom: -80px; /* Kluczowy element - "wciąga" treść pod siebie */
    }
    .header-card {
        background-color: #fff;
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        padding: 1.25rem 1.75rem;
        position: relative; /* Ważne dla z-index */
        z-index: 10;
    }
     .header-card h1 {
        font-size: 1.5rem; /* ZMNIEJSZONO czcionkę (standardowo h2 ma 2rem) */
    }
</style>

<div class="header-background"></div>

<div class="container">
    <div class="header-card">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="h2 text-uppercase mb-0">Zamówienie</h1>
            </div>
            <div class="col-md-6 text-md-end">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-md-end bg-transparent p-0 m-0">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}">Strona główna</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Zamówienie</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            
            <form id="checkout-form" method="POST" action="{% url 'checkout' %}" novalidate>
                {% csrf_token %}

                <div class="accordion" id="checkoutAccordion">

                    <!-- KROK 1: TWOJE KONTO -->
                   <div class="accordion-item">
    <h2 class="accordion-header" id="headingOne">
        <button 
            class="accordion-button {% if user.is_authenticated %}collapsed disabled{% endif %}" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#collapseOne" 
            aria-expanded="{% if user.is_authenticated %}false{% else %}true{% endif %}" 
            aria-controls="collapseOne">
            <strong>1. Logowanie</strong>
        </button>
    </h2>
    <div id="collapseOne" class="accordion-collapse collapse {% if not user.is_authenticated %}show{% endif %}" aria-labelledby="headingOne" data-bs-parent="#checkoutAccordion">
        <div class="accordion-body">
            {% if user.is_authenticated %}
                <p class="mb-0">Jesteś zalogowany jako: <strong>{{ user.email }}</strong>.</p>
            {% else %}
                <p>Masz już konto? Zaloguj się, aby przyspieszyć proces.</p>
                  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">
                ZALOGUJ SIĘ
                </button>
                <hr>
                <p>Nie masz konta? Możesz kontynuować jako gość.</p>
                <button type="button" class="btn btn-primary" data-next-step="collapseTwo">Kontynuuj jako gość</button>
            {% endif %}
        </div>
    </div>
</div>
                    <!-- KROK 2: TWOJE DANE -->
<div class="accordion-item">
    <h2 class="accordion-header" id="headingTwo">
        <button 
            id="btn-collapseTwo" 
            class="accordion-button {% if not user.is_authenticated %}collapsed disabled{% endif %}" 
            type="button" 
            data-bs-toggle="collapse" 
            data-bs-target="#collapseTwo" 
            aria-expanded="{% if user.is_authenticated %}true{% else %}false{% endif %}" 
            aria-controls="collapseTwo">
            <strong>2. Twoje dane</strong>
        </button>
    </h2>
    <div id="collapseTwo" class="accordion-collapse collapse {% if user.is_authenticated %}show{% endif %}" aria-labelledby="headingTwo" data-bs-parent="#checkoutAccordion">
        <!-- ... reszta kodu (formularz) pozostaje bez zmian ... -->
        <div class="accordion-body" data-step="2">
            <p>Proszę podać dane do faktury i wysyłki.</p>
            <div class="row g-2"> <!-- Zmieniono g-3 na g-2 dla mniejszych odstępów -->
                <div class="col-md-6 form-floating form-floating-sm"> 
                    {{ checkout_form.first_name }} 
                    <label for="{{ checkout_form.first_name.id_for_label }}">{{ checkout_form.first_name.label }}</label> 
                    <div class="invalid-feedback">To pole jest wymagane.</div>
                </div>
                <div class="col-md-6 form-floating form-floating-sm"> 
                    {{ checkout_form.last_name }} 
                    <label for="{{ checkout_form.last_name.id_for_label }}">{{ checkout_form.last_name.label }}</label> 
                    <div class="invalid-feedback">To pole jest wymagane.</div>
                </div>
                <div class="col-md-6 form-floating form-floating-sm"> 
                    {{ checkout_form.email }} 
                    <label for="{{ checkout_form.email.id_for_label }}">{{ checkout_form.email.label }}</label> 
                    <div class="invalid-feedback">Proszę podać poprawny adres e-mail.</div>
                </div>
                <div class="col-md-6 form-floating form-floating-sm"> 
                    {{ checkout_form.phone }} 
                    <label for="{{ checkout_form.phone.id_for_label }}">{{ checkout_form.phone.label }}</label> 
                    <div class="invalid-feedback">To pole jest wymagane.</div>
                </div>
                <div class="col-12 form-floating form-floating-sm"> 
                    {{ checkout_form.address1 }} 
                    <label for="{{ checkout_form.address1.id_for_label }}">{{ checkout_form.address1.label }}</label> 
                    <div class="invalid-feedback">To pole jest wymagane.</div>
                </div>
                <div class="col-12 form-floating form-floating-sm"> 
                    {{ checkout_form.address2 }} 
                    <label for="{{ checkout_form.address2.id_for_label }}">{{ checkout_form.address2.label }}</label> 
                </div>
                <div class="col-md-6 form-floating form-floating-sm"> 
                    {{ checkout_form.city }} 
                    <label for="{{ checkout_form.city.id_for_label }}">{{ checkout_form.city.label }}</label> 
                    <div class="invalid-feedback">To pole jest wymagane.</div>
                </div>
                <div class="col-md-6 form-floating form-floating-sm"> 
                    {{ checkout_form.zipcode }} 
                    <label for="{{ checkout_form.zipcode.id_for_label }}">{{ checkout_form.zipcode.label }}</label> 
                    <div class="invalid-feedback">To pole jest wymagane.</div>
                </div>
                <div class="col-12 form-floating form-floating-sm"> 
                    {{ checkout_form.country }} 
                    <label for="{{ checkout_form.country.id_for_label }}">{{ checkout_form.country.label }}</label> 
                </div>
            </div>

            <div class="form-check mt-3"> <!-- Zmniejszono mt-4 na mt-3 -->
                <input class="form-check-input" type="checkbox" id="shipping-address-checkbox" name="shipping-address-checkbox">
                <label class="form-check-label" for="shipping-address-checkbox">Dostawa pod inny adres</label>
            </div>

            <div id="shipping-address-form" style="display: none;" class="mt-3 border-top pt-3">
                <h5>Adres dostawy</h5>
                <div class="row g-2"> <!-- Zmieniono g-3 na g-2 -->
                    <div class="col-md-6 form-floating form-floating-sm"> 
                        {{ shipping_form.shipping_first_name }} 
                        <label for="{{ shipping_form.shipping_first_name.id_for_label }}">{{ shipping_form.shipping_first_name.label }}</label> 
                        <div class="invalid-feedback">To pole jest wymagane.</div>
                    </div>
                    <div class="col-md-6 form-floating form-floating-sm"> 
                        {{ shipping_form.shipping_last_name }} 
                        <label for="{{ shipping_form.shipping_last_name.id_for_label }}">{{ shipping_form.shipping_last_name.label }}</label> 
                        <div class="invalid-feedback">To pole jest wymagane.</div>
                    </div>
                    <div class="col-12 form-floating form-floating-sm"> 
                        {{ shipping_form.shipping_address1 }} 
                        <label for="{{ shipping_form.shipping_address1.id_for_label }}">{{ shipping_form.shipping_address1.label }}</label> 
                        <div class="invalid-feedback">To pole jest wymagane.</div>
                    </div>
                    <div class="col-12 form-floating form-floating-sm"> 
                        {{ shipping_form.shipping_address2 }} 
                        <label for="{{ shipping_form.shipping_address2.id_for_label }}">{{ shipping_form.shipping_address2.label }}</label> 
                    </div>
                    <div class="col-md-6 form-floating form-floating-sm"> 
                        {{ shipping_form.shipping_city }} 
                        <label for="{{ shipping_form.shipping_city.id_for_label }}">{{ shipping_form.shipping_city.label }}</label> 
                        <div class="invalid-feedback">To pole jest wymagane.</div>
                    </div>
                    <div class="col-md-6 form-floating form-floating-sm"> 
                        {{ shipping_form.shipping_zipcode }} 
                        <label for="{{ shipping_form.shipping_zipcode.id_for_label }}">{{ shipping_form.shipping_zipcode.label }}</label> 
                        <div class="invalid-feedback">To pole jest wymagane.</div>
                    </div>
                    <div class="col-12 form-floating form-floating-sm"> 
                        {{ shipping_form.shipping_country }} 
                        <label for="{{ shipping_form.shipping_country.id_for_label }}">{{ shipping_form.shipping_country.label }}</label> 
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-primary mt-3" data-next-step="collapseThree" disabled>Kontynuuj</button> <!-- Dodano btn-sm -->
        </div>
    </div>
</div>
                  <!-- KROK 3: METODA DOSTAWY (PRZEBUDOWANY) -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button id="btn-collapseThree" class="accordion-button collapsed disabled" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                <strong>3. Metoda dostawy</strong>
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#checkoutAccordion">
                            <div class="accordion-body" data-step="3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input delivery-method" type="radio" name="delivery_method" id="inpost_courier" value="courier" data-cost="18.99" required>
                                    <label class="form-check-label" for="inpost_courier">InPost Kurier (18.99 zł)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input delivery-method" type="radio" name="delivery_method" id="inpost_paczkomat" value="locker" data-cost="14.99" required>
                                    <label class="form-check-label" for="inpost_paczkomat">InPost Paczkomat (14.99 zł)</label>
                                </div>

                                <!-- NOWA SEKCJA Z KOMPONENTEM INPOST -->
                                <div id="paczkomat-section" class="mt-3" style="display: none;">
                                    <p class="text-muted small">Wyszukaj lub wybierz paczkomat z mapy poniżej.</p>
                                    
                                    <!-- WAŻNE: Musisz uzyskać swój własny token API od InPost i wkleić go poniżej! -->
                                    <inpost-geowidget 
                                        onpoint="afterPointSelected" 
                                        token= "{{ INPOST_KEY }}"
                                        language="pl"  
                                        config="parcelCollect">
                                    </inpost-geowidget>

                                    <div id="inpost-selected-point" class="mt-2 p-2 border rounded bg-light" style="display: none; font-size: 0.9rem;"></div>
                                    <input type="hidden" name="paczkomat_id" id="paczkomat-id-input">
                                </div>
                                
                                <button type="button" class="btn btn-primary mt-3" data-next-step="collapseFour" disabled>Kontynuuj</button>
                            </div>
                        </div>
                    </div>

                    <!-- KROK 4: PŁATNOŚĆ -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour">
                            <button id="btn-collapseFour" class="accordion-button collapsed disabled" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                <strong>4. Metoda płatności</strong>
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#checkoutAccordion">
                            <div class="accordion-body" data-step="4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="blik" value="blik" required>
                                    <label class="form-check-label" for="blik">BLIK</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="card" value="card" required>
                                    <label class="form-check-label" for="card">Karta płatnicza</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="transfer" value="transfer" required>
                                    <label class="form-check-label" for="transfer">Szybki przelew</label>
                                </div>
                                <button type="button" class="btn btn-primary mt-3" data-next-step="collapseFive" disabled>Kontynuuj</button>
                            </div>
                        </div>
                    </div>

                    <!-- KROK 5: PODSUMOWANIE -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFive">
                            <button id="btn-collapseFive" class="accordion-button collapsed disabled" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                                <strong>5. Podsumowanie</strong>
                            </button>
                        </h2>
                        <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#checkoutAccordion">
                            <div class="accordion-body" data-step="5">
                               <!-- NOWA WERSJA PODSUMOWANIA PRODUKTÓW -->
<h5>Twoje produkty</h5>
<ul class="list-group list-group-flush mb-4">
    {% for item in cart_items %}
    {% with product=item.item_object.product|default:item.item_object %}
    <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
        <div class="d-flex align-items-center">
            <a href="{% url 'product' product.id %}">
                <img src="{{ product.get_main_image }}" alt="{{ product.name }}" width="60" class="me-3 rounded">
            </a>
            <div>
                <strong class="d-block">{{ product.name }}</strong>
                <small class="text-muted">
                    {% if item.item_type == 'variation' %}
                        Rozmiar: {{ item.item_object.size|default:"Brak" }}
                    {% endif %}
                    | Ilość: {{ item.quantity }}
                </small>
            </div>
        </div>
        <span class="fw-bold">{{ item.subtotal|floatformat:2 }} zł</span>
    </li>
    {% endwith %}
    {% endfor %}
</ul>

                                <table class="table table-borderless summary-table">
                                    <tbody>
                                        <tr>
                                            <td>Wartość produktów</td>
                                            <td class="text-end" id="summary-subtotal">{{ totals|floatformat:2 }} zł</td>
                                        </tr>
                                        <tr>
                                            <td>Koszt dostawy</td>
                                            <td class="text-end" id="summary-delivery">0.00 zł</td>
                                        </tr>
                                        <tr class="total-row">
                                            <td>Razem do zapłaty</td>
                                            <td class="text-end" id="summary-grand-total">{{ totals|floatformat:2 }} zł</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" value="" id="terms-checkbox" required>
                                    <label class="form-check-label" for="terms-checkbox">
                                        Akceptuję <a href="{% url 'terms_page' %}" target="_blank">regulamin zoeye.pl</a> i wyrażam zgodę na przetwarzanie danych osobowych na potrzeby realizacji zamówienia (obowiązkowe).
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-4">
                    <button id="submit-order-btn" type="submit" class="btn btn-lg btn-primary" disabled>Zamawiam i płacę</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% endblock %}
{% block scripts %}
<script>
// Ta funkcja MUSI być w globalnym zasięgu, aby komponent <inpost-geowidget> mógł ją znaleźć.
function afterPointSelected(point) {
    console.log('Selected point:', point);
    const selectedPointDiv = document.getElementById('inpost-selected-point');
    const paczkomatIdInput = document.getElementById('paczkomat-id-input');
    
    selectedPointDiv.innerHTML = `<strong>Wybrany paczkomat:</strong><br>${point.name}, ${point.address.line1}, ${point.address.line2}`;
    selectedPointDiv.style.display = 'block';
    paczkomatIdInput.value = point.name; // Zapisujemy ID (nazwę) paczkomatu
    
    // Uruchom walidację przycisku "Kontynuuj" po wybraniu punktu
    const stepBody = paczkomatIdInput.closest('.accordion-body');
    if (stepBody) {
        const continueBtn = stepBody.querySelector('button[data-next-step]');
        if (continueBtn) {
            continueBtn.disabled = false;
        }
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const accordion = document.getElementById('checkoutAccordion');
    if (!accordion) return;

    // --- LOGIKA DLA INPOST ---
    const deliveryRadios = document.querySelectorAll('.delivery-method');
    const paczkomatSection = document.getElementById('paczkomat-section');
    const paczkomatIdInput = document.getElementById('paczkomat-id-input');
    const selectedPointDiv = document.getElementById('inpost-selected-point');

    const checkStep3Button = () => {
        const stepBody = document.querySelector('.accordion-body[data-step="3"]');
        if (!stepBody) return;
        const continueBtn = stepBody.querySelector('button[data-next-step]');
        if (!continueBtn) return;

        let canContinue = false;
        const selectedRadio = stepBody.querySelector('.delivery-method:checked');
        if (selectedRadio) {
            if (selectedRadio.value === 'courier') {
                canContinue = true;
            } else if (selectedRadio.value === 'locker' && paczkomatIdInput.value) {
                canContinue = true;
            }
        }
        continueBtn.disabled = !canContinue;
    };

    deliveryRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'locker') {
                paczkomatSection.style.display = 'block';
            } else {
                paczkomatSection.style.display = 'none';
                paczkomatIdInput.value = '';
                selectedPointDiv.style.display = 'none';
            }
            checkStep3Button();
        });
    });
    // --- KONIEC LOGIKI INPOST ---

    // --- Reszta logiki dla akordeonu i walidacji (bez zmian) ---
    const accordionItems = accordion.querySelectorAll('.accordion-item');
    const submitBtn = document.getElementById('submit-order-btn');
    
    const validateInput = (input) => { /* ... (bez zmian) ... */ };
    const validateStep = (stepBody) => { /* ... (bez zmian) ... */ };
    const checkAndEnableContinueButton = (stepBody) => { /* ... (bez zmian, ale teraz prostsza) ... */ };

    // ... (wklej tutaj resztę swojego działającego kodu JS dla akordeonu,
    //      formularzy, podsumowania, etc. z poprzedniej wersji) ...
    // Poniżej jest kompletna, działająca wersja.
});

// === CAŁY, KOMPLETNY SKRYPT DLA checkout.html ===
function afterPointSelected(point) {
    console.log('Selected point:', point);
    const selectedPointDiv = document.getElementById('inpost-selected-point');
    const paczkomatIdInput = document.getElementById('paczkomat-id-input');
    if (selectedPointDiv && paczkomatIdInput) {
        selectedPointDiv.innerHTML = `<strong>Wybrany paczkomat:</strong><br>${point.name}, ${point.address.line1}, ${point.address.line2}`;
        selectedPointDiv.style.display = 'block';
        paczkomatIdInput.value = point.name;
        
        const stepBody = paczkomatIdInput.closest('.accordion-body');
        const continueBtn = stepBody.querySelector('button[data-next-step]');
        if (continueBtn) continueBtn.disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const accordion = document.getElementById('checkoutAccordion');
    if (!accordion) return;

    const accordionItems = accordion.querySelectorAll('.accordion-item');
    const submitBtn = document.getElementById('submit-order-btn');
    
    const validateInput = (input) => {
        input.classList.remove('is-invalid');
        let isValid = true;
        if (input.required && input.offsetParent !== null) {
            if (input.type === 'radio' || input.type === 'checkbox') {
                if (!input.closest('.accordion-body').querySelector(`input[name="${input.name}"]:checked`)) isValid = false;
            } else if (!input.value.trim()) {
                isValid = false;
            }
        }
        if (input.type === 'email' && input.value.trim() && !/^\S+@\S+\.\S+$/.test(input.value)) isValid = false;
        if (!isValid) input.classList.add('is-invalid');
        return isValid;
    };

    const validateStep = (stepBody) => {
        let allValid = true;
        stepBody.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
            if (!validateInput(input)) allValid = false;
        });
        return allValid;
    };

    const checkAndEnableContinueButton = (stepBody) => {
        const continueBtn = stepBody.querySelector('button[data-next-step]');
        if (!continueBtn) return;

        let canContinue = true;
        stepBody.querySelectorAll('input[required]').forEach(input => {
            if (input.offsetParent !== null) {
                if (input.type === 'radio' || input.type === 'checkbox') {
                    if (!stepBody.querySelector(`input[name="${input.name}"]:checked`)) canContinue = false;
                } else if (!input.value.trim()) {
                    canContinue = false;
                }
            }
        });
        
        if (stepBody.dataset.step === '3') {
            const selectedRadio = stepBody.querySelector('.delivery-method:checked');
            if (selectedRadio) {
                if (selectedRadio.value === 'locker' && !stepBody.querySelector('#paczkomat-id-input').value) {
                    canContinue = false;
                }
            } else {
                canContinue = false;
            }
        }
        continueBtn.disabled = !canContinue;
    };

    accordion.querySelectorAll('button[data-next-step]').forEach(button => {
        button.addEventListener('click', function() {
            const currentStepBody = this.closest('.accordion-body');
            const isStep1 = !currentStepBody.hasAttribute('data-step');
            if (isStep1 || validateStep(currentStepBody)) {
                const nextStepId = this.dataset.nextStep;
                if (nextStepId) {
                    const nextAccordionButton = document.getElementById('btn-' + nextStepId);
                    if (nextAccordionButton) {
                        nextAccordionButton.classList.remove('disabled');
                        nextAccordionButton.click();
                    }
                }
            }
        });
    });

    accordion.addEventListener('show.bs.collapse', function (event) {
        const openingItem = event.target.closest('.accordion-item');
        let openingIndex = -1;
        accordionItems.forEach((item, index) => { if (item === openingItem) openingIndex = index; });
        if (openingIndex !== -1) {
            accordionItems.forEach((item, index) => {
                if (index > openingIndex) {
                    const futureButton = item.querySelector('.accordion-button');
                    if (futureButton) futureButton.classList.add('disabled');
                }
            });
        }
    });

    accordion.querySelectorAll('input, select, textarea').forEach(input => {
        const stepBody = input.closest('.accordion-body');
        if (stepBody) {
            input.addEventListener('input', () => { validateInput(input); checkAndEnableContinueButton(stepBody); });
            input.addEventListener('change', () => checkAndEnableContinueButton(stepBody));
        }
    });

    const shippingCheckbox = document.getElementById('shipping-address-checkbox');
    const shippingForm = document.getElementById('shipping-address-form');
    if (shippingCheckbox && shippingForm) {
        const shippingInputs = shippingForm.querySelectorAll('input, select, textarea');
        const toggleShippingForm = () => {
            const isChecked = shippingCheckbox.checked;
            shippingForm.style.display = isChecked ? 'block' : 'none';
            shippingInputs.forEach(input => { input.required = isChecked; if (!isChecked) input.classList.remove('is-invalid'); });
            checkAndEnableContinueButton(document.querySelector('.accordion-body[data-step="2"]'));
        };
        shippingCheckbox.addEventListener('change', toggleShippingForm);
        toggleShippingForm();
    }

    const termsCheckbox = document.getElementById('terms-checkbox');
    if (termsCheckbox && submitBtn) {
        termsCheckbox.addEventListener('change', function() { submitBtn.disabled = !this.checked; });
    }

    const summaryDeliveryRadios = document.querySelectorAll('.delivery-method');
    const updateSummary = () => {
        const productsTotal = parseFloat("{{ totals|unlocalize }}");
        let deliveryCost = 0;
        const selectedDelivery = document.querySelector('.delivery-method:checked');
        if (selectedDelivery) deliveryCost = parseFloat(selectedDelivery.dataset.cost);
        const grandTotal = productsTotal + deliveryCost;
        document.getElementById('summary-subtotal').textContent = productsTotal.toFixed(2) + ' zł';
        document.getElementById('summary-delivery').textContent = deliveryCost.toFixed(2) + ' zł';
        document.getElementById('summary-grand-total').textContent = grandTotal.toFixed(2) + ' zł';
    };
    
    const paczkomatSection = document.getElementById('paczkomat-section');
    const paczkomatIdInput = document.getElementById('paczkomat-id-input');
    const selectedPointDiv = document.getElementById('inpost-selected-point');

    summaryDeliveryRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            updateSummary();
            if (this.value === 'locker') {
                paczkomatSection.style.display = 'block';
            } else {
                paczkomatSection.style.display = 'none';
                paczkomatIdInput.value = '';
                selectedPointDiv.style.display = 'none';
            }
            checkAndEnableContinueButton(this.closest('.accordion-body'));
        });
    });
    updateSummary();
});
</script>
{% endblock %}